

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Audit, v2.0 ERC20 version &mdash; reality.eth  documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Audit, v3.0 (including ERC20 version)" href="audit_v3.html" />
    <link rel="prev" title="Audit, v2.0" href="audit_v2.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> reality.eth
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="dapp.html">Using the Reality.eth dapp</a></li>
<li class="toctree-l1"><a class="reference internal" href="contracts.html">Using Reality.eth from a contract</a></li>
<li class="toctree-l1"><a class="reference internal" href="arbitrators.html">Arbitrators</a></li>
<li class="toctree-l1"><a class="reference internal" href="fees.html">Fees and payments</a></li>
<li class="toctree-l1"><a class="reference internal" href="whitepaper.html">White paper</a></li>
<li class="toctree-l1"><a class="reference internal" href="contract_explanation.html">Contract Internals</a></li>
<li class="toctree-l1"><a class="reference internal" href="dapp_links.html">Linking to the Reality.eth dapp</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="audit.html">Audit</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="audit_v2.html">Audit, v2.0</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Audit, v2.0 ERC20 version</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#abstract">Abstract</a></li>
<li class="toctree-l3"><a class="reference internal" href="#scope-of-the-audit">Scope of the audit</a></li>
<li class="toctree-l3"><a class="reference internal" href="#conclusions">Conclusions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#references">References</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="audit_v3.html">Audit, v3.0 (including ERC20 version)</a></li>
</ul>
</li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">reality.eth</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="audit.html">Audit</a> &raquo;</li>
        
      <li>Audit, v2.0 ERC20 version</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/audit_v2_ERC20.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="audit-v2-0-erc20-version">
<h1>Audit, v2.0 ERC20 version<a class="headerlink" href="#audit-v2-0-erc20-version" title="Permalink to this headline">¶</a></h1>
<p>Realit.io Modifications
———————-0
for WeTrust.io
Roland Kofler Blockchain Consulting
June 2019</p>
<p>DISCLAIMER: The auditor shall not be held liable to and shall not accept any liability, obligation or responsibility whatsoever for any loss or damage arising from the use of the software. Especially but not only not for undiscovered errors, bugs and vulnerabilities.
Abstract
The Realit.io smart contracts are examined for security vulnerabilities after allowing ERC20 Tokens as a means of payment. Potential vulnerabilities were found in the Code under Audit (sometimes referred as CuA in the text):
1. While benevolence of the token contracts are assumed, we can improve the resilience of the code by checking the successful execution of a transfer: MEDIUM: do not suppose tokens are ER20 compliant. TRST is implemented correctly. It might be contentions to mark this as MEDIUM, but the attitude in this audit is to err on the false positive side.
2. There is a documentation error in a <cite>require</cite> string. MEDIUM: correct <cite>require</cite> string</p>
<p>Ad 1.: Realitio has decided not to change the check for transfer and therefore not to be compliant (at this level) with “BadTokens”, tokens that do not report correctly whether the transfer() function has been called directly. Realitio believes it can write a wrapper for such tokens if necessary. This is plausible.
Ad 2.: Has been implemented <a class="reference external" href="https://github.com/realitio/realitio-contracts/commit/0e6ba5998d83700c8a485e3dead65bc3cdcc965e">https://github.com/realitio/realitio-contracts/commit/0e6ba5998d83700c8a485e3dead65bc3cdcc965e</a>
Additionally also a superfluous comment has been fixed, see Observation 5: constructor comment not consistent:
<a class="reference external" href="https://github.com/realitio/realitio-contracts/commit/b91efd77fc7644e7026d84063462b83eb33574af">https://github.com/realitio/realitio-contracts/commit/b91efd77fc7644e7026d84063462b83eb33574af</a>
Thanks to Ronan Sandford and Shaun Shutte for reviewing the document.</p>
<div class="section" id="abstract">
<h2>Abstract<a class="headerlink" href="#abstract" title="Permalink to this headline">¶</a></h2>
<p>Scope of the audit
The benevolence of Token is mandatory
Also check previous changes to the Contracts under Audit
Methodology
Changes from last audit to the code under audit
Issue 1: <cite>Update and rationalize interface files</cite> and implications
Issue2: Refactor commitment timeout calculation
Issue 3: Duplication of Realito contracts, are they different?
Issue 4: Duplication of Zeppelin ERC20 contracts, are they different?
General observations
Observation 1: Allow later solidity versions
Observation 2: Drop back one minor solc version, deployed with 0.4.25
Observation 3: Duplicate Code IERC20.sol
Observation 4: ERC20Token.sol not latest version
Observation 5: constructor comment not consistent
Audit of CuA
Match Intent of the modifications made
Verify architectural change for ERC20 Tokens
Verify token invariance
Verify token use
Medium: do not suppose tokens are ER20 compliant
MINOR: allowing 0 bounties can spam the log
MEDIUM: correct <cite>require</cite> string
Verify how payments are made
Verify reentrancy protection against token
Verify execution isomorphism of previous changes
MINOR: different Solidity versions in sources
MINOR: there are two BalanceHolder contracts
Results from Mythril
Conclusions
Appendix
List of commits since last audit
Comparing the baseline with the new ERC20 contracts
References
Audit Brief
Audit Clarification
Ethereum Safety
ConsenSys Security Best Practices
DASP
Known Solidity Bugs</p>
</div>
<div class="section" id="scope-of-the-audit">
<h2>Scope of the audit<a class="headerlink" href="#scope-of-the-audit" title="Permalink to this headline">¶</a></h2>
<p>The reason for the audit is the introduction of ERC20 functionality in the code base.</p>
<p>The scope of the audit is the source-code of two solidity smart contract files: (1) the changes in RealitioERC20.sol from Realitio.sol, BalanceHolder.sol and (2) Arbitrator.sol. Everything else is out of scope, for example the deployment of the code.</p>
<p>From the Audit Brief (emphasis mine):</p>
<p>[…]
The audit consists of changes to 2 files, RealitioERC20.sol (changes from Realitio.sol) and Arbitrator.sol. I’ve also updated another auditor contract that I was working on, but it’s not part of the scope of this audit.</p>
<p>The new version is in the branch feature-erc20-audit:
<a class="reference external" href="https://github.com/realitio/realitio-contracts/tree/feature-erc20-audit">https://github.com/realitio/realitio-contracts/tree/feature-erc20-audit</a></p>
<p>All the solidity code changes are in this commit:
<a class="reference external" href="https://github.com/realitio/realitio-contracts/commit/ec8db377d0ef74c5bf599894240f6b54db113338">https://github.com/realitio/realitio-contracts/commit/ec8db377d0ef74c5bf599894240f6b54db113338</a></p>
<p>The benevolence of Token is mandatory
From the Audit Brief:
[…] users must implicitly trust that the token the contract is interacting with isn’t hostile.</p>
<p>Also check previous changes to the Contracts under Audit
From Audit Clarification results the mandate to check the changes since the last audit:</p>
<p>However it would be good if you could verify that what I just said is true, ie that Realitio.sol before the commits I mentioned matches the last thing you audited and I’m not trying to sneak another change past you.
Methodology
The main methods of assessment is structured reading and interpretation. While examination of the Code under Audit, the thoughts of the auditors are recorded.
Furthermore a security analysis tool, Mythril v0.21.3 by ConsenSys Diligence,  was employed to review the Code under Audit.
First we observe the sanity of the codebase created before the Code under Audit(CuA) was introduced (as described in the Appendix Scope of the Audit section), followed by the audit. Checklists of commonly known vulnerabilities are sourced from EthSafety, ConSysSec and DASP.</p>
<p>The following definitions of alert levels are adopted to label vulnerabilities:</p>
<p>CRITICAL        has potential to harm user or owner
MEDIUM        has potential to impede proper functioning of the smart contract
MINOR        there is a better way to do this or is just a matter of diverging tastes</p>
<p>The audit is documented comprehensively with all the base data and interim results provided in order to allow a reconstruction of the results and to document what has been tested and what has not been tested. This comprehensive information should encourage bug bounty hunters and security researchers to pursue their own inquiries.
The audit does not take any philosophical or opinionated position about smart contract security. Between “Code is law” and “upgradeable, pausable, managed and owned” there is much room for debate.
Changes from last audit to the code under audit
Three previous audits have been conducted over the period from January to October 2018.
Since then, new commits have been made (see Appendix List of commits since last audit). These changes are examined here to verify if the requirements for the audit mandate is given at all. Reviewers mentioned that the word <cite>unrisky</cite> does not exist in the english language. Because it best describes the subjective assessment of little risk, this word has been introduced.</p>
<dl class="simple">
<dt>Count        Description</dt><dd><p>30        CAN’T TOUCH CODE UNDER AUDIT
10        UNRISKY FOR CODE UNDER AUDIT
3        SOME RISK FOR CODE UNDER AUDIT</p>
</dd>
</dl>
<p>Figure: subjective risk statistics for the changes before CuA</p>
<p>Issue 1: <cite>Update and rationalize interface files</cite> and implications
* Update and rationalize interface files
* ed authored and ed committed on Oct 20, 2018
* 390f2c9
This commit introduces a <cite>contract Realitio is IBalanceHolder</cite> instead of the old copy &amp; paste of the (1) event and (2) empty <cite>withdraw ()</cite> function.
In the final version of the Code under Audit (CuA) the interface is substituted by an inheritance from an abstract class <cite>BalanceHolderERC20.sol</cite>!
This is an undocumented change not present in Audit Clarification.
The implications will be scrutinized in the AuC and in the main section of this document. {Result after verification: no known risk} .
* Verdict: SOME RISK FOR CODE UNDER AUDIT
Issue2: Refactor commitment timeout calculation
* Break the commitment timeout calculation and storage into its own int…
* Edmund Edgar authored and ed committed on May 17
* 5422046
As the code shows, this is a simple refactoring of a code block into an internal function, as stated in the commit msg.</p>
<blockquote>
<div><p>Verdict: UNRISKY FOR CODE UNDER AUDIT</p>
</div></blockquote>
<p>Issue 3: Duplication of Realito contracts, are they different?
Start ERC20 version with exact copies of our original Realitio.sol co…
ed authored and ed committed 17 days ago
* 4959544
We need to check if the initial versions differ (see Appendix Comparing the baseline with the new ERC20 contracts).</p>
<blockquote>
<div><p>Verdict: UNRISKY FOR CODE UNDER AUDIT</p>
</div></blockquote>
<p>Issue 4: Duplication of Zeppelin ERC20 contracts, are they different?
Assuming the latest Zeppelin version for Solidity 0.4.24 was used (Zeppelin ERC20 Framework v2.0.1).</p>
<p>Comparing
<a class="reference external" href="https://raw.githubusercontent.com/realitio/realitio-contracts/391af7b87145fc5a10555742e931e32b9844f80e/truffle/contracts/ERC20Token.sol">https://raw.githubusercontent.com/realitio/realitio-contracts/391af7b87145fc5a10555742e931e32b9844f80e/truffle/contracts/ERC20Token.sol</a></p>
<p>with
<a class="reference external" href="https://raw.githubusercontent.com/OpenZeppelin/openzeppelin-solidity/v2.0.1/contracts/math/SafeMath.sol">https://raw.githubusercontent.com/OpenZeppelin/openzeppelin-solidity/v2.0.1/contracts/math/SafeMath.sol</a></p>
<p><a class="reference external" href="https://raw.githubusercontent.com/OpenZeppelin/openzeppelin-solidity/v2.0.1/contracts/token/ERC20/IERC20.sol">https://raw.githubusercontent.com/OpenZeppelin/openzeppelin-solidity/v2.0.1/contracts/token/ERC20/IERC20.sol</a></p>
<p><a class="reference external" href="https://raw.githubusercontent.com/OpenZeppelin/openzeppelin-solidity/v2.0.1/contracts/token/ERC20/ERC20.sol">https://raw.githubusercontent.com/OpenZeppelin/openzeppelin-solidity/v2.0.1/contracts/token/ERC20/ERC20.sol</a></p>
<p>Distilled into a file Zeppelin.sol, we are ready to compare the files with a Unix command:</p>
<blockquote>
<div><p>diff –ignore-space-change ERC20Token.sol Zeppelin.sol</p>
</div></blockquote>
<p>Result:</p>
<p>7a8
&gt;
164a166,167
&gt;     require(value &lt;= _allowed[from][msg.sender]);
&gt;
210a214
&gt;     require(value &lt;= _balances[from]);
226,227c230
&lt;     require(account != address(0));
&lt;
—
&gt;     require(account != 0);
240c243,244
&lt;     require(account != address(0));
—
&gt;     require(account != 0);
&gt;     require(value &lt;= _balances[account]);
254a259,260
&gt;     require(value &lt;= _allowed[account][msg.sender]);
&gt;</p>
<p>The sourced contracts do not implement several of the precondition checks Zeppelin has adopted in the latest version of the Solidity 0.4.24 version. It is likely that they are copied from an older commit. Because the code is not inherited or in any other way blended into the logic for the CuA, this is merely a cosmetic issue.</p>
<p>Verdict: UNRISKY FOR CODE UNDER AUDIT
General observations
Some observations not critical for smart contract security.
Observation 1: Allow later solidity versions
* Allow later solidity versions
* ed authored and ed committed on Nov 2, 2018
* 0563976
This is a trade off between security and ease of deployment. Verify at deploy time that the solidity compiler version you deploy to does not expose vulnerabilities. The code base requires different Solidity versions from 0.4.6 to 0.4.25 (Minor: different Solidity versions in sources).
Observation 2: Drop back one minor solc version, deployed with 0.4.25
There are unresolved but no critical bugs in Solidity 0.4.24, please take care (together with Observation 1)
* Drop back one minor solc version, deployed with 0.4.25 but current tr… Edmund Edgar committed on Nov 9, 2018</p>
<p>Specification of known Solc vulnerabilities (see Known Solidity Bugs):
“0.4.24”: {</p>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><p>“bugs”: [</p>
<blockquote>
<div><p>“ABIEncoderV2StorageArrayWithMultiSlotElement”,</p>
<p>“DynamicConstructorArgumentsClippedABIV2”,</p>
<p>“UninitializedFunctionPointerInConstructor_0.4.x”,</p>
<p>“IncorrectEventSignatureInLibraries_0.4.x”,</p>
<p>“ABIEncoderV2PackedStorage_0.4.x”,</p>
<p>“ExpExponentCleanup”,</p>
<p>“EventStructWrongData”</p>
</div></blockquote>
<p>],</p>
<p>“released”: “2018-05-16”</p>
</div></blockquote>
<p>}</p>
</div></blockquote>
<p>Observation 3: Duplicate Code IERC20.sol</p>
</div></blockquote>
<p>The code in the file IERC20.sol is also found in ERC20Token.sol and can be trimmed in one of the files.
Observation 4: ERC20Token.sol not latest version
Consider updating the ERC20Token to the latest v2.0.1 of Zeppelin ERC20 Framework or annotate a warning in the documentation. See Issue 4: Duplication of Zeppelin ERC20 contracts, are they different?.
Observation 5: constructor comment not consistent</p>
<p>Line 193:
/// param _token The token used for everything except arbitration
Maybe intentional as a reminder, but consider to be more explicit.</p>
<p>Verdict: Ignore my observations if you need to deploy soon  :s)</p>
<p>Audit of CuA
The verification of the changes made between the last audit and the Code under Audit (CuA) reported an undocumented change.</p>
<p>All code relevant to the core Audit are checked in a single commit:
* Realitio ERC20 version uses ERC20 for everything except arbitration. … …
* ed authored and ed committed 19 days ago
* ec8db37
Match Intent of the modifications made
From the Project Description (emphasis mine):</p>
<p>The principle is that we will have one RealitioERC20 contract per supported token, and as currently one Arbitrator contract per arbitrator per RealitioERC20 contract. The token is set during initial setup and once set cannot be changed. All question rewards and bonds are denominated in that token.</p>
<p>As previously, arbitration is still denominated and requested in ETH.
If the arbitrator sets a per-question fee, which is deducted from the funds sent to the initial bounty set when a question is created, this is denominated in the token.
Accordingly, the Arbitrator contract now has a single additional function allowing its owner to withdraw ERC20 funds that it may have collected in the RealitioERC20 contract.</p>
<p>Since a RealitioERC20 contract only handles a single token, which cannot be changed after setup, users must implicitly trust that the token the contract is interacting with isn’t hostile. That said, the code is written with the intention that it wouldn’t be subject to reentrancy bugs etc in the event that someone did use it with a maliciously coded token.
[…]</p>
<p>Verify architectural change for ERC20 Tokens
From Audit Brief:
[…] one RealitioERC20 contract per supported token, and as currently one Arbitrator contract per arbitrator per RealitioERC20 contract</p>
<p>Figure: relationships of the contracts under audit</p>
<p>The interpretation of the statement made in the brief, aligns with the structure and behavior in the code.
Verify token invariance
The token is set during initial setup and once set, cannot be changed.</p>
<p>This relationship is enforced In RealitioERC20.sol:</p>
<blockquote>
<div><dl>
<dt>&#64;&#64; -182,8 +181,16 &#64;&#64; contract Realitio is BalanceHolder {</dt><dd><blockquote>
<div><p>_;</p>
</div></blockquote>
<p>}</p>
<p>function setToken(IERC20 _token)
public
{</p>
<blockquote>
<div><p>require(token ==</p>
</div></blockquote>
</dd>
</dl>
</div></blockquote>
<dl>
<dt>IERC20(0x0), “Token can only be initialized once”);</dt><dd><blockquote>
<div><p>token = _token;</p>
</div></blockquote>
<p>}</p>
</dd>
</dl>
<p>Statement is true if setToken is called on deployment.
Verify token use
[…] All question rewards and bonds are denominated in that token.</p>
<p>&#64;&#64; -169,9 +168,9 &#64;&#64; contract Realitio is BalanceHolder {</p>
<dl>
<dt>modifier bondMustDouble(bytes32 question_id) {</dt><dd><blockquote>
<div><p>require(msg.value &gt; 0, “bond must be positive”);
require(msg.value &gt;=
(questions[question_id].bond.mul(2)),</p>
<blockquote>
<div><p>“bond must be double at least previous bond”);</p>
</div></blockquote>
</div></blockquote>
<dl>
<dt>modifier bondMustDouble(bytes32 question_id, uint256 tokens) {</dt><dd><p>require(tokens &gt; 0, “bond must be positive”);
require(tokens &gt;=
(questions[question_id].bond.mul(2)),</p>
<blockquote>
<div><dl class="simple">
<dt>“bond must be double at least previous bond”);</dt><dd><p>_;</p>
</dd>
</dl>
</div></blockquote>
<p>}</p>
</dd>
</dl>
</dd>
</dl>
<p>Line 243: Payable is removed as it is not needed for tokens.</p>
<dl>
<dt>function createTemplateAndAskQuestion(</dt><dd><blockquote>
<div><blockquote>
<div><p>string content,
string question, address arbitrator, uint32 timeout,
uint32 opening_ts, uint256 nonce</p>
</div></blockquote>
<p>)</p>
</div></blockquote>
<dl class="simple">
<dt>// stateNotCreated is enforced by the internal _askQuestion</dt><dd><p>public payable returns (bytes32) {
public returns (bytes32) {</p>
</dd>
</dl>
</dd>
</dl>
<p>Line 284 introduces not only the tokens parameter</p>
<p>change:
&lt;    /// &#64;notice Ask a new question with a bounty and return the ID
—
&gt;     /// &#64;notice Ask a new question and return the ID
New line:
&lt;     /// &#64;param tokens The combined initial question bounty and question fee
Change:
&lt;     function askQuestionERC20(uint256 template_id, string question, address arbitrator, uint32 timeout, uint32 opening_ts, uint256 nonce, uint256 tokens)
—
&gt;     function askQuestion(uint256 template_id, string question, address arbitrator, uint32 timeout, uint32 opening_ts, uint256 nonce)</p>
<p>&lt;     public returns (bytes32) {
&lt;
&lt;         _deductTokensOrRevert(tokens);
—
&gt;     public payable returns (bytes32) {</p>
<p>&lt;         _askQuestion(question_id, content_hash, arbitrator, timeout, opening_ts, tokens);
—
&gt;         _askQuestion(question_id, content_hash, arbitrator, timeout, opening_ts);</p>
<p>Line 330 and line 336:</p>
<ul class="simple">
<li><p>uint256 bounty = tokens;</p></li>
</ul>
<ul class="simple">
<li><p>uint256 bounty = msg.value;</p></li>
</ul>
<p>The replacement of an uint256 value contained in msg.value with one in the parameter tokens, arguably cannot introduce new vulnerabilities as their value range is the same and no gas implication are known.</p>
<p>Line 284 Function
function askQuestionERC20(uint256 template_id, string question, address arbitrator, uint32 timeout, uint32 opening_ts, uint256 nonce, uint256 tokens)</p>
<p>Line 286 payable gone: that’s fine
Line 288 _deduceTokensOrRevert()
MEDIUM: do not suppose tokens are ER20 compliant</p>
<p>A new function is introduced:
function _deductTokensOrRevert(uint256 tokens)</p>
<blockquote>
<div><p>internal {</p>
<blockquote>
<div><dl class="simple">
<dt>if (tokens == 0) {</dt><dd><p>return;</p>
</dd>
</dl>
<p>}</p>
<p>uint256 bal = balanceOf[msg.sender];</p>
</div></blockquote>
</div></blockquote>
<dl>
<dt>// Deduct any tokens you have in your internal balance first</dt><dd><dl>
<dt>if (bal &gt; 0) {</dt><dd><dl class="simple">
<dt>if (bal &gt;= tokens) {</dt><dd><p>balanceOf[msg.sender] = bal.sub(tokens);
return;</p>
</dd>
<dt>} else {</dt><dd><p>tokens = tokens.sub(bal);
balanceOf[msg.sender] = 0;</p>
</dd>
</dl>
<p>}</p>
</dd>
</dl>
<p>}
// Now we need to charge the rest from</p>
</dd>
<dt>require(token.transferFrom(msg.sender, address(this),   tokens), “Transfer of tokens failed, insufficient approved balance?”);</dt><dd><blockquote>
<div><p>return;</p>
</div></blockquote>
<p>}</p>
</dd>
</dl>
<p>If no token exists we stop deducing tokens and allow the function to execute.
Then we retrieve the balance of the sender.
Functions that call this private function are
* fundAnswerBountyERC20
* askQuestionERC20
* submitAnswerERC20
* submitAnswerCommitmentERC20</p>
<p>Only if a balance exists, can we look to subtract tokens from the balance of the sender.
But if the balance is less than the tokens suggested, we get all the money from the balance and just use the tokens that are possible. This is defensive and allows a frictionless usage of the function.
Still there is a potential issue with
require(token.transferFrom(msg.sender, address(this),   tokens), “Transfer of tokens failed, insufficient approved balance?”);</p>
<p>Others (Richard Meissner from Gnosis) have acknowledged that not all tokens return the boolean value correctly:
<a class="reference external" href="https://github.com/gnosis/safe-contracts/blob/5a8b07326faf30c644361c9d690d57dbeb838698/contracts/common/SecuredTokenTransfer.sol">https://github.com/gnosis/safe-contracts/blob/5a8b07326faf30c644361c9d690d57dbeb838698/contracts/common/SecuredTokenTransfer.sol</a>
The fact that Gnosis makes the choice to verify the token transfer in this complicated way indicates that there are tokens that do not implement the return value correctly or that it is seen as a potential threat. This is supported by empirical evidence (see Gitter Chat)</p>
<p>From Gnosis Gitter:
Roland Kofler &#64;rolandkofler 15:28
what is the rationale behind SecuredTokenTransfer.sol? especially do you find that transfer functions are not implemented correctly in important token contracts to that you need this functionality? &#64;rmeissner</p>
<p>Andrew Redden &#64;androolloyd 15:30
Some tokens aren’t implemented corrected and their return status doesn’t indicate a success.</p>
<p>Wrappers are used to catch the diff return codes to ensure that no unintended reverts will occur</p>
<p>Roland Kofler &#64;rolandkofler 15:31
thank you, can you give an example of such a token &#64;androolloyd ?</p>
<p>Andrew Redden &#64;androolloyd 15:33
Off hand I don’t have a list, I believe some implementations in OpenZeppelin were incorrect.</p>
<p>Some quick googling should suffice.</p>
<p>Roland Kofler &#64;rolandkofler 15:34
<a class="reference external" href="https://medium.com/coinmonks/missing-return-value-bug-at-least-130-tokens-affected-d67bf08521ca">https://medium.com/coinmonks/missing-return-value-bug-at-least-130-tokens-affected-d67bf08521ca</a>
thank you</p>
<dl>
<dt>TRST is implemented correctly:</dt><dd><p>// See ERC20
// WARNING: If you call this with the address of a contract, the contract will receive the
// funds, but will have no idea where they came from. Furthermore, if the contract is
// not aware of TRST, the tokens will remain locked away in the contract forever.
// It is always recommended to call instead compareAndApprove() (or approve()) and have the
// receiving contract withdraw the money using transferFrom().
function transfer(address _to, uint256 _value) public returns (bool) {</p>
<blockquote>
<div><dl class="simple">
<dt>if (balances[msg.sender] &gt;= _value) {</dt><dd><p>balances[msg.sender] -= _value;
balances[_to] += _value;
Transfer(msg.sender, _to, _value);
return true;</p>
</dd>
</dl>
<p>}
return false;</p>
</div></blockquote>
<p>}</p>
<p>// See ERC20
function transferFrom(address _from, address _to, uint256 _value) public returns (bool) {</p>
<blockquote>
<div><dl class="simple">
<dt>if (balances[_from] &gt;= _value &amp;&amp; allowed[_from][msg.sender] &gt;= _value) {</dt><dd><p>balances[_from] -= _value;
allowed[_from][msg.sender] -= _value;
balances[_to] += _value;
Transfer(_from, _to, _value);
return true;</p>
</dd>
</dl>
<p>}
return false;</p>
</div></blockquote>
<p>}</p>
</dd>
</dl>
<p>Added token parameter 326:
function _askQuestion(bytes32 question_id, bytes32 content_hash, address arbitrator, uint32 timeout, uint32 opening_ts, uint256 tokens)</p>
<p>Removed 336:  uint256 bounty = msg.value;</p>
<p>If msg.sender is not the arbitrator then the question fee is applied and it is that the bounty, is at least the question fee. We then subtract the fee from the bounty.</p>
<p>And we add it:</p>
<blockquote>
<div><p>Line 361 function fundAnswerBountyERC20(bytes32 question_id, uint256 tokens)</p>
</div></blockquote>
<p>Add funds to bounty of a question even after the question is created. Can be done even in arbitration before finalization.
Arguably the arbiter gets no fees from a bounty.
But now it’s with tokens.
Now tokens is deducted, because we have to do accounting now. Not ethereum blocks.
It allows for 0 bounties. That’s strange.
Should it? Mark it minor as it spams the log
MINOR: allowing 0 bounties can spam the log
Consider if it is intentional to allow for zero bounties, it might be contentions to mark this as MEDIUM, but the attitude in this audit is to err on the false positive side.</p>
<dl class="simple">
<dt>questions[question_id].bounty = questions[question_id].bounty.add(msg.value);</dt><dd><p>emit LogFundAnswerBounty(question_id, msg.value, questions[question_id].bounty, msg.sender);</p>
</dd>
</dl>
<blockquote>
<div><p>emit LogFundAnswerBounty(question_id, tokens, questions[question_id].bounty, msg.sender);</p>
</div></blockquote>
<p>Accounting and then doing the same with bounty accounting as with normal eth,
cannot really make something more wrong:</p>
<dl>
<dt>Line 375:</dt><dd><blockquote>
<div><p>stateOpen(question_id)
bondMustDouble(question_id, tokens)
previousBondMustNotBeatMaxPrevious</p>
<blockquote>
<div><p>(question_id, max_previous)</p>
</div></blockquote>
<dl class="simple">
<dt>external {</dt><dd><p>_deductTokensOrRevert(tokens);</p>
</dd>
</dl>
</div></blockquote>
<p>_addAnswerToHistory(question_id, answer,</p>
</dd>
<dt>msg.sender, tokens, false);</dt><dd><p>_updateCurrentAnswer(question_id, answer,</p>
</dd>
<dt>questions[question_id].timeout);</dt><dd><p>}</p>
</dd>
</dl>
<p>Here also the accounting function is added and the payable removed, this is a pattern.
Cannot introduce new problems.</p>
<p>Line 408:
function submitAnswerCommitmentERC20(bytes32 question_id, bytes32 answer_hash, uint256 max_previous, address _answerer, uint256 tokens)</p>
<blockquote>
<div><blockquote>
<div><p>stateOpen(question_id)
bondMustDouble(question_id, tokens)</p>
</div></blockquote>
<dl>
<dt>previousBondMustNotBeatMaxPrevious(question_id,</dt><dd><blockquote>
<div><p>max_previous)</p>
</div></blockquote>
<p>external {</p>
</dd>
</dl>
</div></blockquote>
<p>Seems to be the same as we have done until now.
It’s isomorph and therefore can not introduce new problems.
MEDIUM: correct <cite>require</cite> string
<a class="reference external" href="https://github.com/realitio/realitio-contracts/blob/77f79aec8e2976c0cf44820ec9daf159991df832/truffle/contracts/RealitioERC20.sol#L344">https://github.com/realitio/realitio-contracts/blob/77f79aec8e2976c0cf44820ec9daf159991df832/truffle/contracts/RealitioERC20.sol#L344</a></p>
<dl class="simple">
<dt>Replace <cite>ETH</cite> with <cite>tokens</cite> or similar</dt><dd><p>require(bounty &gt;= question_fee, “ETH provided must cover question fee”);</p>
</dd>
</dl>
<p>Verify how payments are made
arbitration is still denominated and requested in ETH.</p>
<p>Found to be true in code, as there is no change here</p>
<p>per-question fee, which is deducted from the funds sent to the initial bounty set when a question is created, this is denominated in the token.</p>
<p>Found to be true in the newly introduced helper method bounty or revert</p>
<p>the Arbitrator contract now has a single additional function allowing its owner to withdraw ERC20 funds that it may have collected in the RealitioERC20 contract.</p>
<p>/// &#64;Withdraw any accumulated token fees to the specified address
/// addr The address to which the balance should be sent
/// Only needed if the Realitio contract used is using an ERC20 token
/// Also only normally useful if a per-question fee is set, otherwise we only have ETH.</p>
<blockquote>
<div><dl class="simple">
<dt>function withdrawERC20(IERC20 _token, address addr)</dt><dd><p>onlyOwner</p>
</dd>
<dt>public {</dt><dd><p>uint256 bal = _token.balanceOf(address(this));
IERC20(_token).transfer(addr, bal);</p>
</dd>
</dl>
<p>}</p>
</div></blockquote>
<p>So if the arbitrator address has tokens he can transfer it to a certain balance.</p>
<p>Verify reentrancy protection against token
the code is written with the intention that it wouldn’t be subject to reentrancy bugs etc in the event that someone did use it with a maliciously coded token.</p>
<p>This was always the case and did not change. Especially no state change happens after any transfer in the functions RealitionERC20.withdrawToRegisteredWalletERC20(), BalancHolder.withdraw().
Verify execution isomorphism of previous changes
And from Audit Clarification results:</p>
<p><a class="reference external" href="https://github.com/realitio/realitio-contracts/commit/5422046c510dc86ea1ede715b77d9a1673f5b72f">https://github.com/realitio/realitio-contracts/commit/5422046c510dc86ea1ede715b77d9a1673f5b72f</a></p>
<p><a class="reference external" href="https://github.com/realitio/realitio-contracts/commit/c64f28ce0c2d292fd2b0835ce8656e26e0d97c27">https://github.com/realitio/realitio-contracts/commit/c64f28ce0c2d292fd2b0835ce8656e26e0d97c27</a></p>
<p>These two changes are made to Realitio.sol that are intended to leave its behaviour unchanged, but make it easier to make the subsequent RealitioERC.sol version work with minimal changes. This is then cloned to RealitioERC20.sol and all the subsequent action is in RealitioERC20.sol, plus an extra function in Arbitrator.sol.</p>
<p>This has been shown to be true!
MINOR: different Solidity versions in sources
Issuing cmd find in /truffle/contracts:</p>
<p>find . -type f -exec grep “^0.4” ‘{}’ ; -print</p>
<p>Shows that there are many different solidity versions employed. Can be unified. Note
./SplitterWallet.sol uses pragma solidity ^0.4.25;</p>
<p>pragma solidity ^0.4.6;
./CallbackClient.sol
pragma solidity ^0.4.24;
./IRealitio.sol
pragma solidity ^0.4.24;
./Arbitrator.sol
pragma solidity ^0.4.18;
./IBalanceHolder.sol
pragma solidity ^0.4.6;
./ExplodingCallbackClient.sol
pragma solidity ^0.4.24;
./RegisteredWalletArbitrator.sol
pragma solidity ^0.4.2;
./Migrations.sol
pragma solidity ^0.4.15;
./MultiSigWallet.sol
pragma solidity ^0.4.24;
./Zeppelin.sol
pragma solidity ^0.4.24;
./RealitioSafeMath32.sol
pragma solidity ^0.4.24;
./RealitioSafeMath256.sol
pragma solidity ^0.4.24;
./ERC20Token.sol
pragma solidity ^0.4.24;
./RealitioERC20.sol
pragma solidity ^0.4.18;
./Owned.sol
pragma solidity ^0.4.24;
./Realitio.sol
pragma solidity ^0.4.24;
./IERC20.sol
pragma solidity ^0.4.25;
./SplitterWallet.sol
pragma solidity ^0.4.18;
./BalanceHolder.sol
pragma solidity ^0.4.18;
./BalanceHolderERC20.sol</p>
<p>MINOR: there are two BalanceHolder contracts
Both BalanceHolder.sol and BalanceHolderERC20.sol contain a contract named BalanceHolder. The name of a solidity file has no grammatical influence in the compilation process. Consider renaming BalanceHolder for ERC20 to BalanceHolderERC20, to explicitly express the desire to inherit from a specific contract.</p>
<p>Results from Mythril
docker run -v $(pwd):/tmp mythril/myth –solv 0.4.24 -x /tmp/RealitioERC20.sol
Executing: wget <a class="reference external" href="https://github.com/ethereum/solidity/releases/download/v0.4.24/solc-static-linux">https://github.com/ethereum/solidity/releases/download/v0.4.24/solc-static-linux</a> -c -O /root/.py-solc/solc-v0.4.24/bin/solc
Checking installed executable version &#64; /root/.py-solc/solc-v0.4.24/bin/solc
Executing: /root/.py-solc/solc-v0.4.24/bin/solc –version
solc successfully installed at: /root/.py-solc/solc-v0.4.24/bin/solc</p>
<p>The analysis was completed successfully. No issues were detected.</p>
<p>docker run -v $(pwd):/tmp mythril/myth –solv 0.4.24 -x /tmp/BalanceHolderERC20.sol
[…]
==== External Call To Fixed Address ====
SWC ID: 107
Severity: Low
Contract: BalanceHolder
Function name: withdraw()
PC address: 625
Estimated Gas Usage: 7038 - 28314
The contract executes an external message call.
An external function call to a fixed contract address is executed. Make sure that the callee contract has been reviewed carefully.
——————–
In file: /tmp/BalanceHolderERC20.sol:20</p>
<p>token.transfer(msg.sender, bal)</p>
<hr class="docutils" />
<p>The Mythril advice is acknowledged by Realitio and consciously excluded from the audit.
Each Token contract needs to be scrupulously examined as a new potential threat to the security of RealitoERC20.</p>
<p>docker run -v $(pwd):/tmp mythril/myth –solv 0.4.24 -x /tmp/Arbitrator.sol
The tool hangs and consumes all the computer resources. I cannot use the tool on Arbitrator.sol.</p>
</div>
<div class="section" id="conclusions">
<h2>Conclusions<a class="headerlink" href="#conclusions" title="Permalink to this headline">¶</a></h2>
<p>By current standards of security audits and the best knowledge of the auditor the changes made in the Code under Audit do introduce 2 new potential security threats.
1. While benevolence of the token contracts are assumed, we can still improve the resilience of the code by checking the successful execution of a transfer: MEDIUM: do not suppose tokens are ER20 compliant. It might be contentions to mark this as MEDIUM, but the attitude in this audit is to err on the false positive side.
2. There is a documentation error in a <cite>require</cite> string. MEDIUM: correct <cite>require</cite> string.  It might be contentions to mark this as MEDIUM, but the attitude in this audit is to err on the false positive side.</p>
<p>Minor improvements can be made, consider renaming the BalanceHolder contract for ERC20 to BalanceHolderER20 to explicitly reflect the correct dependency and allow for grammatical checks.
For the changes based on the audit, see also Abstract</p>
<p>Roland Kofler Blockchain Consulting is honored to help the pioneering work of Realitio and WeTrust to change our world  for the better. Please reach out to me personally any time.</p>
<p><a class="reference external" href="mailto:roland&#37;&#52;&#48;ibc&#46;technology">roland<span>&#64;</span>ibc<span>&#46;</span>technology</a>
<a class="reference external" href="mailto:roland&#46;kofler&#37;&#52;&#48;gmail&#46;com">roland<span>&#46;</span>kofler<span>&#64;</span>gmail<span>&#46;</span>com</a>
+4915783430243
Appendix
List of commits since last audit
This is the full assessment of the commits before and after CuA commits.
The colors reflect the first inspection to identify potential problems.</p>
<dl class="simple">
<dt>Count        Description</dt><dd><p>30        CAN’T TOUCH CODE UNDER AUDIT
10        UNRISKY FOR CODE UNDER AUDIT
3        SOME RISK FOR CODE UNDER AUDIT</p>
</dd>
</dl>
<p>Figure: subjective risk statistics for the changes until the audit.</p>
<p>Commits on Jun 8, 2019
* tidy, add tests of token balance handling
* ed authored and ed committed 15 days ago
* 77f79ae
* Recompile with ERC20 version
* ed authored and ed committed 15 days ago
* 5c52bd9
* Realitio ERC20 version uses ERC20 for everything except arbitration. … …
* ed authored and ed committed 19 days ago
* ec8db37
Commits on Jun 4, 2019</p>
<blockquote>
<div><p>Add Zeppelin ERC20 interface, plus token contract for tests</p>
</div></blockquote>
<p>ed authored and ed committed 19 days ago
391af7b
Start ERC20 version with exact copies of our original Realitio.sol co…
ed authored and ed committed 17 days ago
* 4959544
* Remove bondMustBeZero modifier, which as auditor previously pointed o…
* Edmund Edgar authored and ed committed on May 17
* * Break the commitment timeout calculation and storage into its own int…
* Edmund Edgar authored and ed committed on May 17
* 5422046
* ⭐CuA        Merge branch ‘master’ of github.com:realitio/realitio-contracts</p>
<blockquote>
<div><p>ed authored and ed committed 15 days ago</p>
</div></blockquote>
<ul class="simple">
<li><p>e5ccb98</p></li>
<li><ul>
<li><p>Test updates: Test compiled code not sourcce code, update to python3 …</p></li>
</ul>
</li>
<li><p>ed authored and ed committed 15 days ago</p></li>
<li><p>83b4475</p></li>
</ul>
<p>Commits on May 28, 2019
* Kleros integration is now ready for prime-time
* Edmund Edgar committed 22 days ago
* 72351a2
* Kleros contract updates
* Edmund Edgar committed 22 days ago
* 771c443
Commits on May 11, 2019
* Update kleros contract addresses
* Edmund Edgar committed on May 11
* 5a8b298
Commits on May 4, 2019
* New kleros arbitrator addresses
* Edmund Edgar committed on May 4
* 477d01b
Commits on Apr 10, 2019
* updated kleros contract addresses, now with metaevidence
* Edmund Edgar committed on Apr 10
* f80e6ca
Commits on Apr 2, 2019
* Add Kleros arbitrator options
* Edmund Edgar committed on Apr 2
* 92cd12e
Commits on Feb 13, 2019
* Add kovan arbitrator setting
* edmundedgar committed on Feb 13
* 97b53b5
* Add Kovan contracts
* edmundedgar committed on Feb 13
* f1a9aa5
Commits on Nov 27, 2018
* Move wrongly-placed contract json definitions
* ed authored and ed committed on Nov 27, 2018
* 6e8173a
* Compiled contracts for a multi-sig arbitrator
* ed authored and ed committed on Nov 27, 2018
* 9b556f9
* Delete MultiSigArbitratorController, we’re instead using a combinatio… …
* ed authored and ed committed on Nov 27, 2018
* 3db1ce8
Commits on Nov 17, 2018
* Add Registered Wallet Arbitrator contract for use in arbitration cons… …
* ed authored and ed committed on Nov 17, 2018
Not part of contracts under audit
* 0c2ee2a
* Rename functions and rearrange to clarify how duplicate addresses are… …
ed authored and ed committed on Nov 17, 2018</p>
<blockquote>
<div><p>Changes are isomorph.</p>
</div></blockquote>
<p>By definition isomorphic instructions will produce exactly the sameoutput</p>
<blockquote>
<div><ul class="simple">
<li><p>f75e802</p></li>
</ul>
</div></blockquote>
<dl class="simple">
<dt>Commits on Nov 15, 2018</dt><dd><ul class="simple">
<li><p>Test the worst case for gas usage (100 addresses, all new and differe… …</p></li>
<li><p>ed authored and ed committed on Nov 15, 2018</p></li>
<li><p>7348310</p></li>
<li><p>Add gas test for max recipient limit</p></li>
<li><p>ed authored and ed committed on Nov 15, 2018</p></li>
<li><p>7d2c999</p></li>
<li><p>Add require error message</p></li>
<li><p>ed authored and ed committed on Nov 15, 2018</p></li>
<li><p>d434d90</p></li>
<li><p>More tests</p></li>
<li><p>ed authored and ed committed on Nov 15, 2018</p></li>
<li><p>ab0ba0a</p></li>
<li><p>Add error messages to require statements</p></li>
<li><p>ed authored and ed committed on Nov 15, 2018</p></li>
<li><p>80b82fa</p></li>
<li><p>improve comments</p></li>
<li><p>ed authored and ed committed on Nov 15, 2018</p></li>
<li><p>09f851b</p></li>
<li><p>Add some asserts to make sure we never allocate more money than we ha… …</p></li>
<li><p>ed authored and ed committed on Nov 15, 2018</p></li>
<li><p>bd65641</p></li>
</ul>
</dd>
<dt>Commits on Nov 14, 2018</dt><dd><ul class="simple">
<li><p>Tests for splitter wallet</p></li>
<li><p>ed authored and ed committed on Nov 14, 2018</p></li>
<li><p>106a6ce</p></li>
<li><p>Rename</p></li>
<li><p>ed authored and ed committed on Nov 14, 2018</p></li>
<li><p>7c863da</p></li>
<li><p>Delete old callback code tests: We didn’t get that code audited, and … …</p></li>
<li><p>ed authored and ed committed on Nov 14, 2018</p></li>
<li><p>b55d054</p></li>
<li><p>Fix comment</p></li>
<li><p>ed authored and ed committed on Nov 14, 2018</p></li>
<li><p>a7a34a7</p></li>
<li><p>Multisig arbitration contracts for arbitration consortiums, based on … …</p></li>
<li><p>ed authored and ed committed on Nov 14, 2018</p></li>
<li><p>f633aea</p></li>
</ul>
</dd>
<dt>Commits on Nov 9, 2018</dt><dd><ul class="simple">
<li><p>Bump minor version</p></li>
<li><p>Edmund Edgar committed on Nov 9, 2018</p></li>
<li><p>e1a07c5</p></li>
<li><p>Drop back one minor solc version, deployed with 0.4.25 but current tr… …</p></li>
<li><p>Edmund Edgar committed on Nov 9, 2018</p></li>
<li><p>b730748</p></li>
<li><p>Recent contracts need a higher gas limit, don’t force the network id</p></li>
<li><p>Edmund Edgar committed on Nov 9, 2018</p></li>
<li><p>bd09d75</p></li>
</ul>
</dd>
<dt>Commits on Nov 2, 2018</dt><dd><ul class="simple">
<li><p>Bump version</p></li>
<li><p>Edmund Edgar committed on Nov 2, 2018</p></li>
<li><p>052af40</p></li>
<li><p>Allow later solidity versions</p></li>
<li><p>ed authored and ed committed on Nov 2, 2018</p></li>
<li><p>0563976</p></li>
</ul>
</dd>
<dt>Commits on Oct 27, 2018</dt><dd><ul class="simple">
<li><p>interface should also inherit interface</p></li>
<li><p>ed authored and ed committed on Oct 27, 2018</p></li>
<li><p>e222de7</p></li>
<li><p>Rename interface contracts as I…</p></li>
<li><p>ed authored and ed committed on Oct 27, 2018</p></li>
<li><p>872c697</p></li>
</ul>
</dd>
<dt>Commits on Oct 26, 2018</dt><dd><ul class="simple">
<li><p>bump version number</p></li>
<li><p>Edmund Edgar committed on Oct 26, 2018</p></li>
<li><p>bcbf35b</p></li>
</ul>
</dd>
<dt>Commits on Oct 20, 2018</dt><dd><ul class="simple">
<li><p>bump version</p></li>
<li><p>Edmund Edgar committed on Oct 20, 2018</p></li>
<li><p>033b61a</p></li>
<li><p>Redeploy ganache bootstrap contracts</p></li>
<li><p>ed authored and ed committed on Oct 20, 2018</p></li>
<li><p>6aafc45</p></li>
<li><p>Rename contract name in migrations</p></li>
<li><p>ed authored and ed committed on Oct 20, 2018</p></li>
<li><p>40ad612</p></li>
<li><p>Update and rationalize interface files</p></li>
<li><p>ed authored and ed committed on Oct 20, 2018</p></li>
<li><p>390f2c9</p></li>
<li><p>Add ganache-bootstrap addresses</p></li>
<li><p>ed authored and ed committed on Oct 20, 2018</p></li>
<li><p>cbabddb</p></li>
<li><p>bump version</p></li>
<li><p>Edmund Edgar committed on Oct 20, 2018                                                              8f762f8</p></li>
<li><p>correct mistaken network ID</p></li>
<li><p>Edmund Edgar committed on Oct 20, 2018</p></li>
<li><p>81f36df</p></li>
<li><p>Newly-deployed contracts in config files</p></li>
<li><p>Edmund Edgar committed on Oct 20, 2018</p></li>
<li><p>b31e9d5</p></li>
</ul>
</dd>
<dt>Comparing the baseline with the new ERC20 contracts</dt><dd><p>git checkout 49595443742afe1d8ae0495110a78d1cc780970e
sdiff BalanceHolder.sol BalanceHolderERC20.sol</p>
</dd>
</dl>
<p>pragma solidity ^0.4.18;                                pragma solidity ^0.4.18;</p>
<p>contract BalanceHolder {                                contract BalanceHolder {</p>
<blockquote>
<div><p>mapping(address =&gt; uint256) public balanceOf;            mapping(address =&gt; uint256) public balanceOf;</p>
<dl class="simple">
<dt>event LogWithdraw(                                            event LogWithdraw(</dt><dd><p>address indexed user,                                        address indexed user,
uint256 amount                                                uint256 amount</p>
</dd>
</dl>
<p>);                                                            );</p>
<p>function withdraw()                                     function withdraw()
public {                                                    public {</p>
<blockquote>
<div><p>uint256 bal = balanceOf[msg.sender];                        uint256 bal = balanceOf[msg.sender];
balanceOf[msg.sender] = 0;                                balanceOf[msg.sender] = 0;
msg.sender.transfer(bal);                                msg.sender.transfer(bal);
emit LogWithdraw(msg.sender, bal);                          emit LogWithdraw(msg.sender, bal);</p>
</div></blockquote>
<p>}                                                            }</p>
</div></blockquote>
<p>}                                                        }</p>
<p>No differences detected</p>
<p>Now I only use <cite>diff</cite> for large files to output only differences:</p>
<blockquote>
<div><p>diff Arbitrator.sol ArbitratorERC20.sol
Output:</p>
</div></blockquote>
<p>No differences detected</p>
</div>
<div class="section" id="references">
<h2>References<a class="headerlink" href="#references" title="Permalink to this headline">¶</a></h2>
<p>Audit Brief
Email: “Realitio WeTrust integration audit”, Edmund Edgar &lt;<a class="reference external" href="mailto:ed&#37;&#52;&#48;socialminds&#46;jp">ed<span>&#64;</span>socialminds<span>&#46;</span>jp</a>&gt;, 8 June 2019 at 04:51, To: Roland &lt;<a class="reference external" href="mailto:roland&#46;kofler&#37;&#52;&#48;gmail&#46;com">roland<span>&#46;</span>kofler<span>&#64;</span>gmail<span>&#46;</span>com</a>&gt;, Cc: Hoang Nguyen &lt;<a class="reference external" href="mailto:hoang&#37;&#52;&#48;wetrust&#46;io">hoang<span>&#64;</span>wetrust<span>&#46;</span>io</a>&gt;</p>
<p>[…]
The audit consists of changes to 2 files, RealitioERC20.sol (changes from Realitio.sol) and Arbitrator.sol. I’ve also updated another auditor contract that i was working on, but it’s not part of the scope of this audit.</p>
<p>The new version is in the branch feature-erc20-audit
<a class="reference external" href="https://github.com/realitio/realitio-contracts/tree/feature-erc20-audit">https://github.com/realitio/realitio-contracts/tree/feature-erc20-audit</a></p>
<p>All the solidity code changes are in this commit:
<a class="reference external" href="https://github.com/realitio/realitio-contracts/commit/ec8db377d0ef74c5bf599894240f6b54db113338">https://github.com/realitio/realitio-contracts/commit/ec8db377d0ef74c5bf599894240f6b54db113338</a></p>
<p>The principle is that we will have one RealitioERC20 contract per supported token, and as currently one Arbitrator contract per arbitrator per RealitioERC20 contract. The token is set during initial setup and once set cannot be changed. All question rewards and bonds are denominated in that token.</p>
<p>As previously, arbitration is still denominated and requested in ETH.
If the arbitrator sets a per-question fee, which is deducted from the funds sent to the initial bounty set when a question is created, this is denominated in the token.
Accordingly, the Arbitrator contract now has a single additional function allowing its owner to withdraw ERC20 funds that it may have collected in the RealitioERC20 contract.</p>
<p>Since a RealitioERC20 contract only handles a single token, which cannot be changed after setup, users must implicitly trust that the token the contract is interacting with isn’t hostile. That said, the code is written with the intention that it wouldn’t be subject to reentrancy bugs etc in the event that someone did use it with a maliciously coded token.</p>
<p>I’ve updated the tests to use python3 and recent versions of the ever-changing python test stuff - unfortunately I haven’t yet figured out how to adjust the block gas limit in my test code, and I don’t want to keep everyone waiting while I do so if you want to run them you have to hack this file.
<a class="reference external" href="https://github.com/ethereum/eth-tester/blob/b9ad39a9ee8ef041d2ca2d2c2d1d1e28d3f36da9/eth_tester/backends/pyevm/main.py#L66">https://github.com/ethereum/eth-tester/blob/b9ad39a9ee8ef041d2ca2d2c2d1d1e28d3f36da9/eth_tester/backends/pyevm/main.py#L66</a>
[…]
Audit Clarification
Email: 15 June 2019 at 22:33 From Edmund Edgar &lt;<a class="reference external" href="mailto:ed&#37;&#52;&#48;socialminds&#46;jp">ed<span>&#64;</span>socialminds<span>&#46;</span>jp</a>&gt;
To: Roland &lt;<a class="reference external" href="mailto:roland&#46;kofler&#37;&#52;&#48;gmail&#46;com">roland<span>&#46;</span>kofler<span>&#64;</span>gmail<span>&#46;</span>com</a>&gt; Subject:        Realitio WeTrust integration audit</p>
<p>Yes, that chain of kleros commits should just be changes to the arbitrators list, and the kleros arbitration contract that’s the subject of those changes (along with kleros itself) is out of scope. There shouldn’t be any changes to the contracts in scope (Realitio.sol, duplicated to RealitioERC20.sol and Arbitrator.sol) until you get to:</p>
<p><a class="reference external" href="https://github.com/realitio/realitio-contracts/commit/5422046c510dc86ea1ede715b77d9a1673f5b72f">https://github.com/realitio/realitio-contracts/commit/5422046c510dc86ea1ede715b77d9a1673f5b72f</a></p>
<p><a class="reference external" href="https://github.com/realitio/realitio-contracts/commit/c64f28ce0c2d292fd2b0835ce8656e26e0d97c27">https://github.com/realitio/realitio-contracts/commit/c64f28ce0c2d292fd2b0835ce8656e26e0d97c27</a></p>
<p>These two are changes made to Realitio.sol that are intended to leave its behaviour unchanged but make it easier to make the subsequent RealitioERC.sol version work with minimal changes. This is then cloned to RealitioERC20.sol and all the subsequent action is in RealitioERC20.sol, plus an extra function in Arbitrator.sol.</p>
<dl class="simple">
<dt>However it would be good if you could verify that what I just said is true, ie that Realitio.sol before the commits I mentioned matches the last thing you audited and I’m not trying to sneak another change past you.</dt><dd><p>[…]</p>
</dd>
</dl>
<p>Ethereum Safety
<a class="reference external" href="https://github.com/ethereum/wiki/wiki/Safety">https://github.com/ethereum/wiki/wiki/Safety</a>
ConsenSys Security Best Practices
ConsenSys Security Best Practice
<a class="reference external" href="https://consensys.github.io/smart-contract-best-practices/">https://consensys.github.io/smart-contract-best-practices/</a>
DASP
Decentralised Application Security Project
<a class="reference external" href="https://dasp.co/">https://dasp.co/</a>
Known Solidity Bugs
<a class="reference external" href="https://solidity.readthedocs.io/en/v0.5.9/bugs.html">https://solidity.readthedocs.io/en/v0.5.9/bugs.html</a>
<a class="reference external" href="https://github.com/ethereum/solidity/blob/develop/docs/bugs_by_version.json">https://github.com/ethereum/solidity/blob/develop/docs/bugs_by_version.json</a></p>
<p>/</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="audit_v3.html" class="btn btn-neutral float-right" title="Audit, v3.0 (including ERC20 version)" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="audit_v2.html" class="btn btn-neutral float-left" title="Audit, v2.0" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2017, KK Social Minds.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>